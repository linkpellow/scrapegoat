[build]
builder = "NIXPACKS"

[build.env]
# Install Playwright browsers during build
PLAYWRIGHT_BROWSERS_PATH = "/opt/ms-playwright"

[deploy]
setupCommand = "python -m playwright install --with-deps chromium"
startCommand = "echo 'Redis URL:' && echo $APP_REDIS_URL | head -c 50 && echo '...' && echo 'Broker URL:' && echo $APP_CELERY_BROKER_URL | head -c 50 && echo '...' && export APP_DATABASE_URL=$(echo $APP_DATABASE_URL | sed 's|^postgresql://|postgresql+psycopg://|') && celery -A app.celery_app worker --loglevel=info --concurrency=2 --pool=solo"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

